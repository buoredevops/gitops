node {
    def app
    stage ('Clone repository') 
    {
        checkout scm
    }

    stage ('Test image') {
        app.inside {
            sh 'echo "Test stage passed"'
        }
    }

    stage ('Push image') {
        docker.withRegistry('https://registry.hub.docker.com', 'dockerhub') {
            app.push("${env.BUILD_NUMBER}")
        }
    }

    stage ('Update GIT') {
        script {
            catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                withCredentials([usernamePassword(credentialsId: 'github', passwordVariable: 'GIT_PASSWORD',  usernameVariable: 'GIT_USERNAME')]) {
                    //def encodePassword = URLEncoder.encode("$GIT_PASSWORD", 'UTF-8')
                    //git config user.email
                    //git config user.name

                    sh "cat demoapp-deployment.yaml"
                    sh "sed -i 's+buore/demoapp:${env.BUILD_NUMBER}+g' demoapp-deployment.yaml"
                    sh "cat demoapp-deployment.yaml"
                    sh "git add ."
                    sh "git commit -m 'Triggered Build: ${env.BUILD_NUMBER}' "
                    sh "git push https://${GIT_USERNAME}@github.com/${GIT_USERNAME}/buoredevops/gitops.git  HEAD:main"

                }
            }
        }
    }
}